{% extends "web/base.html" %}
{% load static %}

{% block title %}Richiedi nuovo OTP | Tixy{% endblock %}

{% block content %}
<main class="main">
  {% with bc='assets/img/breadcrumb/01.jpg' %}
  <div class="site-breadcrumb" style="background-image:url('{% static bc %}')">
    <div class="container">
      <h2 class="breadcrumb-title">Richiedi nuovo OTP</h2>
      <ul class="breadcrumb-menu">
        <li><a href="{% url 'home' %}">Home</a></li>
        <li class="active">Nuovo OTP</li>
      </ul>
    </div>
  </div>
  {% endwith %}

  <div class="auth-area py-100">
    <div class="container">
      <div class="col-md-5 col-lg-4 mx-auto">
        <div class="auth-wrap">
          <div class="auth-header">
            <img src="{% static 'assets/img/logo/moon.png' %}" class="logo-dark-mode" alt="logo">
            <img src="{% static 'assets/img/logo/sun.png' %}" class="logo-light-mode" alt="logo">
            <p>Richiedi un nuovo codice OTP</p>
          </div>
          <div class="auth-form">
            <form id="refreshForm" action="#">
              <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-control" name="refresh" placeholder="La tua email" required>
              </div>
              <div class="auth-btn">
                <button type="submit" class="theme-btn"><span class="far fa-sync"></span>Richiedi nuovo OTP</button>
              </div>
            </form>
            <div class="auth-footer">
              <p>Hai gi√† il codice? <a href="{% url 'conferma_otp' %}">Conferma OTP</a></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const refreshForm = document.getElementById("refreshForm");
      if (refreshForm) {
        refreshForm.addEventListener("submit", async function(e) {
          e.preventDefault();
          const refresh = refreshForm.querySelector('input[name="refresh"]').value;
          try {
            const res = await fetch("http://127.0.0.1:8001/api/auth/token/refresh/", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ refresh })
            });
            const data = await res.json();
            if (res.ok) {
              alert("Nuovo OTP inviato! Controlla la tua email.");
            } else {
              alert(data.detail || "Errore nella richiesta OTP");
            }
          } catch (err) {
            alert("Errore di rete");
          }
        });
      }
    });
  </script>
</main>
{% endblock %}