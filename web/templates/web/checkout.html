{% extends "web/base.html" %}
{% load static %}

{% block title %}Conferma Acquisto | Tixy{% endblock %}

{% block content %}

<!-- BREADCRUMB -->
<div class="site-breadcrumb" style="background-image:url('{% static "assets/img/breadcrumb/01.jpg" %}')">
  <div class="container">
    <h2 class="breadcrumb-title">Conferma Acquisto</h2>
    <ul class="breadcrumb-menu">
      <li><a href="{% url 'home' %}">Home</a></li>
      <li class="active">Conferma acquisto</li>
    </ul>
  </div>
</div>

<section class="checkout-area py-80">
  <div class="container">

    <!-- MESSAGGI DJANGO -->
    {% if messages %}
      <div class="mb-3">
        {% for m in messages %}
          <div class="alert alert-{{ m.tags|default:"info" }}">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- STEPPER -->
    <div class="checkout-steps">
      <div class="step done"><span>1</span><small>Evento</small></div>
      <div class="step active"><span>2</span><small>Riepilogo</small></div>
      <div class="step"><span>3</span><small>Pagamento</small></div>
      <div class="step"><span>4</span><small>Conferma</small></div>
    </div>

    <!-- AUTH INLINE (solo se non loggato) -->
    {% if auth_required %}
    <div class="row g-4 mb-30">
      <!-- LOGIN -->
      <div class="col-lg-6">
        <div class="checkout-card">
          <div class="checkout-card-header">
            <h4>Accedi</h4>
          </div>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="login">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input class="form-control" type="email" name="email" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input class="form-control" type="password" name="password" required>
              <div class="form-text">
                <a href="{% url 'password_forgot' %}">Hai dimenticato la password?</a>
              </div>
            </div>
            <button class="theme-btn w-100" type="submit">Accedi</button>
          </form>
        </div>
      </div>

      <!-- REGISTRAZIONE -->
      <div class="col-lg-6">
        <div class="checkout-card">
          <div class="checkout-card-header">
            <h4>Registrati</h4>
            <p class="hint">Riceverai un codice OTP (in locale lo vedi nei log API).</p>
          </div>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="register">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nome</label>
                <input class="form-control" type="text" name="first_name" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Cognome</label>
                <input class="form-control" type="text" name="last_name" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input class="form-control" type="email" name="email" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Password</label>
                <input class="form-control" type="password" name="password" required>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="regTerms" name="accepted_terms" required>
                  <label class="form-check-label" for="regTerms">Accetto i Termini</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="regPrivacy" name="accepted_privacy" required>
                  <label class="form-check-label" for="regPrivacy">Accetto la Privacy</label>
                </div>
              </div>
              <div class="col-12">
                <button class="theme-btn w-100" type="submit">Registrati</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row g-4">

      <!-- COLONNA SX: CONSENSI + PROSEGUI -->
      <div class="col-lg-8">
        <div class="checkout-card">
          <div class="checkout-card-header">
            <h4>Riepilogo & Consensi</h4>
          </div>

          <form method="post" class="row g-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="prosegui">
            <input type="hidden" name="qty" value="{{ qty|default:1 }}">

            {% if not auth_required and profilo %}
              <div class="col-12">
                <div class="alert alert-light" style="border:1px solid var(--border-info-color);">
                  Sei autenticato come <strong>{{ profilo.first_name }} {{ profilo.last_name }}</strong>
                  (<span style="opacity:.9">{{ profilo.email }}</span>).
                </div>
              </div>
            {% endif %}

            <div class="col-12">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="chkTerms" name="accepted_terms" required>
                <label class="form-check-label" for="chkTerms">
                  Accetto i <a href="{% url 'termini' %}" target="_blank" rel="noopener">Termini di servizio</a>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkPrivacy" name="accepted_privacy" required>
                <label class="form-check-label" for="chkPrivacy">
                  Ho letto l’<a href="{% url 'termini' %}" target="_blank" rel="noopener">Informativa privacy</a>
                </label>
              </div>
            </div>

            <div class="col-12">
              <button class="theme-btn w-100" type="submit" {% if auth_required %}disabled{% endif %}>
                Prosegui al pagamento
              </button>
              {% if auth_required %}
                <small class="d-block mt-1" style="opacity:.8;">
                  Accedi o registrati qui sopra per abilitare il pulsante.
                </small>
              {% endif %}
            </div>
          </form>
        </div>
      </div>

      <!-- COLONNA DX: RIEPILOGO ORDINE -->
      <div class="col-lg-4">
        <aside class="summary-box">
          <h5 class="summary-title">Riepilogo ordine</h5>

          {% with p=listing.performance_info %}
          <div class="summary-event">
            <h6 class="event-name">{{ p.evento_nome }}</h6>
            <ul class="event-meta">
              <li><i class="fa-regular fa-calendar"></i>
                {% if p.starts_at_fmt %}{{ p.starts_at_fmt }}{% else %}{{ p.starts_at_utc }}{% endif %}
              </li>
              <li><i class="fa-solid fa-location-dot"></i> {{ p.luogo_nome }}</li>
              {% if listing.seller_info %}
                <li><i class="fa-solid fa-user"></i> Venditore:
                  {{ listing.seller_info.first_name }} {{ listing.seller_info.last_name }}
                </li>
              {% endif %}
            </ul>
          </div>
          {% endwith %}

          <div class="summary-items">
            <!-- Riga principale: posti / categoria / prezzo unitario -->
            <div class="item">
              <div>
                {% if listing.seat_category %}
                  <strong>Posto:</strong> {{ listing.seat_category }}
                  {% if listing.row %}, Fila {{ listing.row }}{% endif %}
                  {% if listing.seat_from or listing.seat_to %}
                    , Posti {{ listing.seat_from }}{% if listing.seat_to %}-{{ listing.seat_to }}{% endif %}
                  {% endif %}
                {% else %}
                  <strong>Posti:</strong> {{ listing.qty|default:qty }}
                {% endif %}
              </div>
              <div class="price">€ {{ listing.price_each }}</div>
            </div>

            <!-- Se abbiamo i calcoli di preview, mostriamo subtotal + commission -->
            {% if preview_subtotal %}
              <div class="item">
                <div><strong>Quantità</strong> × {{ qty|default:1 }}</div>
                <div class="price">€ {{ preview_subtotal }}</div>
              </div>
            {% endif %}

            {% if preview_commission %}
              <div class="item">
                <div>Commissioni</div>
                <div class="price">€ {{ preview_commission }}</div>
              </div>
            {% endif %}

            <!-- Cambio nominativo (solo se dovuto) -->
            {% if change_required and change_fee and change_fee|floatformat:2 != "0.00" %}
              <div class="item">
                <div>Cambio nominativo</div>
                <div class="price">€ {{ change_fee }}</div>
              </div>
            {% endif %}
          </div>

          <!-- TOTALE -->
          <div class="summary-total">
            <span>Totale</span>
            <strong>
              € {% if final_total %}{{ final_total }}{% elif preview_total %}{{ preview_total }}{% elif preview.total %}{{ preview.total }}{% else %}{{ listing.price_each }}{% endif %}
            </strong>
          </div>

          {% if change_msg %}
            <div class="summary-safe" style="margin-top:8px;">
              <i class="fa-solid fa-circle-info"></i>
              {{ change_msg }}
            </div>
          {% endif %}

          <div class="summary-safe">
            <i class="fa-solid fa-shield-check"></i>
            Pagamento sicuro • Protezione acquisto
          </div>
        </aside>

        <div class="help-box mt-20">
          <i class="fa-regular fa-circle-question"></i>
          Hai domande? <a href="{% url 'faq' %}">Leggi le FAQ</a>
        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}
