{% extends "web/base.html" %}
{% load static %}
{% load tz %}

{% block title %}Profilo & Sicurezza — Tixy{% endblock %}
{% block body_class %}account account-profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/admin.css' %}?v=3">
<style>
  .verify-badge {
    display:inline-flex; align-items:center; gap:.5rem;
    padding:.35rem .6rem; border-radius:999px; font-weight:600; font-size:.9rem;
  }
  .verify-badge--ok   { background:rgba(16,185,129,.12); color:#10b981; border:1px solid rgba(16,185,129,.35); }
  .verify-badge--warn { background:rgba(245,158,11,.12); color:#f59e0b; border:1px solid rgba(245,158,11,.35); }
  .verify-list .item { display:flex; align-items:center; justify-content:space-between; padding:.4rem 0; border-bottom:1px dashed rgba(0,0,0,.06); }
  .verify-list .item:last-child { border-bottom:0; }
  .kbd { background:#f5f6f8; border:1px solid #e5e7eb; padding:.1rem .45rem; border-radius:.35rem; font-size:.85rem;}
</style>
{% endblock %}

{% block content %}
<!-- HERO -->
<section class="account-hero account-hero--sm account-hero--overlay"
         style="background-image:url({% static 'assets/img/breadcrumb/01.jpg' %})">
  <div class="container d-flex align-items-center justify-content-between">
    <div>
      <h1 class="m-0 account-hero__title">Area Riservata</h1>
      <p class="subtitle m-0 account-hero__subtitle">Profilo &amp; Sicurezza</p>
    </div>
    <div>
      {% comment %}
        Regola visuale: utente verificato se c'è telefono + almeno un social (is_verified_visual).
        Mostriamo badge verde se true, altrimenti badge giallo con suggerimenti.
      {% endcomment %}
      {% if is_verified_visual %}
        <span class="verify-badge verify-badge--ok" title="Telefono e almeno un social presenti">
          <i class="far fa-badge-check"></i> Utente verificato
        </span>
      {% else %}
        <span class="verify-badge verify-badge--warn" title="Aggiungi telefono e almeno un social">
          <i class="far fa-triangle-exclamation"></i> Verifica incompleta
        </span>
      {% endif %}
    </div>
  </div>
</section>

<section class="account-wrap">
  <div class="container">
    <div class="row g-3">

      <!-- SIDEBAR -->
      <aside class="col-lg-3">
        <div class="account-sidebar">
          <div class="box-head">
            <h5 class="m-0">Menu Account</h5>
            <small class="text-muted">Mister Alert</small>
          </div>
          <nav class="nav-account" aria-label="Menu account">
            <a class="nav-item" href="{% url 'account_admin' %}" data-route="dashboard">
              <i class="far fa-gauge-high"></i> Dashboard
            </a>
            <a class="nav-item" href="{% url 'account_alerts' %}" data-route="alert">
              <i class="far fa-bell"></i> I miei Alert
            </a>
            <a class="nav-item" href="{% url 'account_subscriptions' %}" data-route="abbonamenti">
              <i class="far fa-crown"></i> Abbonamenti
            </a>
            <a class="nav-item" href="{% url 'account_tickets' %}" data-route="acquisti">
              <i class="far fa-bag-shopping"></i> Acquisti
            </a>
            <a class="nav-item" href="{% url 'account_resales' %}" data-route="rivendita">
              <i class="far fa-tags"></i> Rivendita
            </a>
            <a class="nav-item" href="{% url 'account_support_list' %}" data-route="assistenza">
              <i class="far fa-life-ring"></i> Assistenza
            </a>
            <a class="nav-item active" href="{% url 'account_profile' %}" data-route="profilo">
              <i class="far fa-user-shield"></i> Profilo &amp; Sicurezza
            </a>
            {% if profilo.is_staff %}
            <a class="nav-item" href="{{ API_BASE_URL|default:'#' }}/admin/" target="_blank" rel="noopener">
              <i class="far fa-screwdriver-wrench"></i> Backoffice
            </a>
            {% endif %}
          </nav>
        </div>
      </aside>

      <!-- MAIN -->
      <div class="col-lg-9">

        {% if messages %}
          {% for m in messages %}
            <div class="alert alert-{{ m.tags|default:'info' }}">{{ m }}</div>
          {% endfor %}
        {% endif %}

        <!-- PANNELLO STATO VERIFICA -->
        <div class="card card-ghost mb-3">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>
              <h4 class="m-0">Stato verifica venditore</h4>
              <small class="text-muted">La home mostra “venditore verificato” se hai un telefono e almeno un social</small>
            </div>
            {% if is_verified_visual %}
              <span class="verify-badge verify-badge--ok">
                <i class="far fa-badge-check"></i> Verificato
              </span>
            {% else %}
              <span class="verify-badge verify-badge--warn">
                <i class="far fa-triangle-exclamation"></i> Incompleto
              </span>
            {% endif %}
          </div>
          <div class="card-body">
            <div class="verify-list">
              <div class="item">
                <span><i class="far fa-phone me-2"></i>Telefono</span>
                {% if has_phone %}
                  <span class="badge badge-soft success">Presente</span>
                {% else %}
                  <span class="badge badge-soft warning">Mancante</span>
                {% endif %}
              </div>
              <div class="item">
                <span><i class="far fa-share-nodes me-2"></i>Almeno un social</span>
                {% if has_any_social %}
                  <span class="badge badge-soft success">Presente</span>
                {% else %}
                  <span class="badge badge-soft warning">Mancante</span>
                {% endif %}
              </div>

              {% comment %}
                Se il backend invia anche dei flag “verificati” (es. controllo manuale), li mostriamo come info.
              {% endcomment %}
              {% if phone_verified is not None or socials_verified is not None %}
              <div class="mt-3 small text-muted">
                Stato backend:&nbsp;
                {% if phone_verified %}<span class="kbd">telefono verificato</span>{% else %}<span class="kbd">telefono non verificato</span>{% endif %}
                &nbsp;•&nbsp;
                {% if socials_verified %}<span class="kbd">social verificati</span>{% else %}<span class="kbd">social non verificati</span>{% endif %}
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- DATI PROFILO -->
        <form class="card card-ghost mb-3" method="post" action="{% url 'account_profile' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_profile">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>
              <h4 class="m-0">Dati profilo</h4>
              <small class="text-muted">Aggiorna le tue informazioni personali e i social</small>
            </div>
            <button type="submit" class="btn btn-primary"><i class="far fa-save me-2"></i>Salva</button>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nome</label>
                <input type="text" class="form-control" name="first_name" value="{{ profilo.first_name|default:'' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Cognome</label>
                <input type="text" class="form-control" name="last_name" value="{{ profilo.last_name|default:'' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Email (non modificabile)</label>
                <input type="email" class="form-control" value="{{ profilo.email|default:'' }}" disabled>
              </div>
              <div class="col-md-6">
                <label class="form-label">Telefono</label>
                <input type="text" class="form-control" name="phone" value="{{ profilo.phone|default:'' }}" placeholder="+39 …">
                <div class="form-text">Inserisci un numero valido per risultare verificata/o.</div>
              </div>

              <!-- SOCIAL -->
              <div class="col-12"><hr class="my-1"></div>

              <div class="col-md-6">
                <label class="form-label">Facebook</label>
                <input type="url" class="form-control" name="facebook_url" value="{{ profilo.facebook_url|default:'' }}" placeholder="https://facebook.com/…">
              </div>
              <div class="col-md-6">
                <label class="form-label">Instagram</label>
                <input type="url" class="form-control" name="instagram_url" value="{{ profilo.instagram_url|default:'' }}" placeholder="https://instagram.com/…">
              </div>
              <div class="col-md-6">
                <label class="form-label">TikTok</label>
                <input type="url" class="form-control" name="tiktok_url" value="{{ profilo.tiktok_url|default:'' }}" placeholder="https://tiktok.com/@…">
              </div>
              <div class="col-md-6">
                <label class="form-label">X (ex Twitter)</label>
                <input type="url" class="form-control" name="x_url" value="{{ profilo.x_url|default:'' }}" placeholder="https://x.com/…">
              </div>
              <div class="col-md-12">
                <label class="form-label">Sito web</label>
                <input type="url" class="form-control" name="website_url" value="{{ profilo.website_url|default:'' }}" placeholder="https://…">
              </div>

              <div class="col-12">
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="marketing_ok" name="marketing_ok"
                         {% if profilo.marketing_ok %}checked{% endif %}>
                  <label class="form-check-label" for="marketing_ok">
                    Desidero ricevere aggiornamenti e offerte (facoltativo)
                  </label>
                </div>
              </div>
            </div>
          </div>
        </form>

        <!-- SICUREZZA -->
        <form class="card card-ghost mb-3" method="post" action="{% url 'account_profile' %}" novalidate>
          {% csrf_token %}
          <input type="hidden" name="action" value="change_password">
          <div class="card-header">
            <h4 class="m-0">Sicurezza</h4>
            <small class="text-muted">Cambia password</small>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Password attuale</label>
                <input type="password" class="form-control" name="old_password" autocomplete="current-password">
              </div>
              <div class="col-md-4">
                <label class="form-label">Nuova password</label>
                <input type="password" class="form-control" name="new_password" autocomplete="new-password" minlength="8">
              </div>
              <div class="col-md-4">
                <label class="form-label">Ripeti nuova password</label>
                <input type="password" class="form-control" name="new_password2" autocomplete="new-password" minlength="8">
              </div>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-end">
            <button type="submit" class="btn btn-outline-primary"><i class="far fa-key me-2"></i>Cambia password</button>
          </div>
        </form>

        <!-- DANGER ZONE (opzionale/placeholder) -->
        <form class="card card-ghost border-danger" method="post" action="{% url 'account_profile' %}"
              onsubmit="return confirm('Sei sicura/o di voler eliminare l’account? L’operazione è irreversibile.');">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete_account">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>
              <h5 class="m-0 text-danger">Danger zone</h5>
              <small class="text-muted">Elimina definitivamente il tuo account</small>
            </div>
            <button type="submit" class="btn btn-danger"><i class="far fa-user-slash me-2"></i>Elimina account</button>
          </div>
        </form>

      </div><!-- /col-lg-9 -->
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    // attiva "profilo" nel menu laterale
    const path = (location.pathname || '/').replace(/\/+$/,'').toLowerCase();
    const rules = [
      ['abbonamenti', ['/account/abbonamenti','abbonamenti','subscription','subscriptions']],
      ['alert',       ['/account/alerts','alert','alerts']],
      ['rivendita',   ['rivendita']],
      ['assistenza',  ['assistenza','supporto','help','/account/support']],
      ['acquisti',    ['/account/tickets','acquisti']],
      ['profilo',     ['/account/profile','/account/profilo','profilo','profile','sicurezza']],
      ['dashboard',   ['/account','dashboard']],
    ];
    function matches(tokens){
      return tokens.some(t => t.startsWith('/') ? path.startsWith(t.toLowerCase())
                                               : path.includes(t.toLowerCase()));
    }
    let key = 'profilo';
    for (const [k, toks] of rules){ if (matches(toks)) { key = k; break; } }
    document.querySelectorAll('.nav-account a').forEach(a => {
      a.classList.toggle('active', a.dataset.route === key);
    });
  })();
</script>
{% endblock %}
