{% extends "web/base.html" %}
{% load static %}
{% load tz %}

{% block title %}Tixy — Carica biglietto{% endblock %}
{% block body_class %}account{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
<link rel="stylesheet" href="{% static 'assets/css/admin.css' %}?v=3">
{% endblock %}

{% block content %}
<section class="account-hero account-hero--sm account-hero--overlay"
         style="background-image:url({% static 'assets/img/breadcrumb/01.jpg' %})">
  <div class="container d-flex align-items-center justify-content-between">
    <div>
      <h1 class="m-0 account-hero__title">Carica nuovo biglietto</h1>
      <p class="subtitle m-0 account-hero__subtitle">Seleziona l’evento dal portale e carica PDF o URL.</p>
    </div>
    <div>
      <a href="{% url 'account_resales' %}" class="theme-btn theme-btn--outline">
        <i class="far fa-arrow-left me-1"></i> Torna alla Rivendita
      </a>
    </div>
  </div>
</section>

<section class="account-wrap">
  <div class="container">
    <div class="row g-3">
      <!-- Sidebar -->
      <aside class="col-lg-3">
        <div class="account-sidebar">
          <div class="box-head">
            <h5 class="m-0">Menu Account</h5>
            <small class="text-muted">Mister Alert</small>
          </div>
          <nav class="nav-account" aria-label="Menu account">
            <a class="nav-item" href="{% url 'account_admin' %}" data-route="dashboard"><i class="far fa-gauge-high"></i> Dashboard</a>
            <a class="nav-item" href="{% url 'account_alerts' %}" data-route="alert"><i class="far fa-bell"></i> I miei Alert</a>
            <a class="nav-item" href="{% url 'account_subscriptions' %}" data-route="abbonamenti"><i class="far fa-crown"></i> Abbonamenti</a>
            <a class="nav-item" href="{% url 'account_tickets' %}" data-route="acquisti"><i class="far fa-bag-shopping"></i> Acquisti</a>
            <a class="nav-item active" href="{% url 'account_resales' %}" data-route="rivendita"><i class="far fa-tags"></i> Rivendita</a>
            <a class="nav-item" href="{% url 'account_support_list' %}" data-route="assistenza"><i class="far fa-life-ring"></i> Assistenza</a>
            <a class="nav-item" href="{% url 'account_profile' %}" data-route="profilo"><i class="far fa-user-shield"></i> Profilo &amp; Sicurezza</a>
          </nav>
        </div>
      </aside>

      <!-- Main -->
      <div class="col-lg-9">
        <div class="card card-ghost">
          <div class="card-header"><h4 class="m-0">Dati biglietto</h4></div>

          <form class="card-body" method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            <div class="row g-3">
              <!-- 1) Evento/performance con autocomplete -->
              <div class="col-12">
                <label class="form-label">Evento (cerca per nome, artista o città)</label>
                <input 
                  type="text" 
                  id="event-search" 
                  class="form-control" 
                  placeholder="Inizia a digitare per cercare..."
                  autocomplete="off"
                >
                <input type="hidden" name="performance" id="performance-id" required>
                <div id="search-results" class="search-results"></div>
                <small class="form-text text-muted">Seleziona l'evento dalla lista dei risultati</small>
              </div>

              <!-- 2) Quantità -->
              <div class="col-md-3">
                <label class="form-label">Quantità</label>
                <input type="number" class="form-control" name="qty" min="1" step="1" value="1" required>
                <div class="form-text">Potrai selezionare i singoli nominativi dopo l’analisi PDF.</div>
              </div>

              <!-- 3) Prezzo richiesto (iniziale) -->
              <div class="col-md-3">
                <label class="form-label">Prezzo richiesto (EUR)</label>
                <input type="number" class="form-control" name="price_each" min="0" step="0.01" placeholder="es. 59.00" required>
              </div>

              <!-- 4) Prezzo del biglietto (faciale / max) -->
              <div class="col-md-3">
                <label class="form-label">Prezzo del biglietto (MAX)</label>
                <input type="number" class="form-control" name="face_value_price" min="0" step="0.01" placeholder="valore sul biglietto" required>
                <div class="form-text">Valore facciale: limite massimo consentito.</div>
              </div>

              <!-- 5) Prezzo minimo di vendita -->
              <div class="col-md-3">
                <label class="form-label">Prezzo minimo (EUR)</label>
                <input type="number" class="form-control" name="min_price" min="0" step="0.01" placeholder="es. 30.00" required>
              </div>

              <!-- TOP -->
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="is_top" name="is_top">
                  <label class="form-check-label" for="is_top">
                    Rendi l’annuncio <strong>TOP</strong>
                  </label>
                </div>
                <div class="form-text">
                  TOP: commissioni <strong>10%</strong> sul venduto. Senza TOP: commissioni <strong>2%</strong>.
                </div>
              </div>

              <!-- 6) PDF o URL -->
              <div class="col-md-6">
                <label class="form-label">Carica PDF (alternativo a URL)</label>
                <input type="file" class="form-control" name="ticket_file" accept="application/pdf">
                <div class="form-text">Se carichi il PDF, dedurremo “PDF” come modalità di consegna.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">URL biglietto digitale (alternativo al PDF)</label>
                <input type="url" class="form-control" name="ticket_url" placeholder="https://…">
                <div class="form-text">Se compili l’URL (senza PDF), dedurremo “E-TICKET”.</div>
              </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
              <button type="submit" class="theme-btn">
                <i class="far fa-cloud-upload-alt me-1"></i> Avvia caricamento
              </button>
            </div>
          </form>
        </div>
      </div><!-- /col-lg-9 -->
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Menu attivo
  document.querySelectorAll('.nav-account a')
    .forEach(a => a.classList.toggle('active', a.dataset.route === 'rivendita'));

  // Autocomplete per ricerca eventi
  const searchInput = document.getElementById('event-search');
  const hiddenInput = document.getElementById('performance-id');
  const resultsDiv = document.getElementById('search-results');
  let debounceTimer;

  if (!searchInput || !hiddenInput || !resultsDiv) {
    console.error('Elementi autocomplete non trovati');
    return;
  }

  searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();

    if (query.length < 2) {
      resultsDiv.classList.remove('show');
      hiddenInput.value = '';
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(`/api/search/performances/?q=${encodeURIComponent(query)}&page_size=10`)
        .then(res => res.json())
        .then(data => {
          const results = data.results || [];
          
          if (results.length === 0) {
            resultsDiv.innerHTML = '<div class="search-no-results">Nessun evento trovato</div>';
            resultsDiv.classList.add('show');
            return;
          }

          resultsDiv.innerHTML = results.map(item => `
            <div class="search-result-item" data-id="${item.id}" data-name="${escapeHtml(item.evento_nome)}" data-venue="${escapeHtml(item.luogo_nome)}" data-date="${item.starts_at_utc}">
              <div class="event-title">${escapeHtml(item.evento_nome) || 'Evento'}</div>
              <div class="event-meta">
                <i class="far fa-location-dot"></i> ${escapeHtml(item.luogo_nome) || ''} · 
                <i class="far fa-calendar"></i> ${formatDate(item.starts_at_utc)}
              </div>
            </div>
          `).join('');

          resultsDiv.classList.add('show');

          // Aggiungi evento click a ogni risultato
          resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              
              const perfId = this.dataset.id;
              const eventName = this.dataset.name;
              const venue = this.dataset.venue;
              const date = this.dataset.date;
              
              // Imposta il valore visibile
              searchInput.value = `${eventName} - ${venue} - ${formatDate(date)}`;
              
              // Imposta l'ID nascosto
              hiddenInput.value = perfId;
              
              // Chiudi i risultati
              resultsDiv.classList.remove('show');
              resultsDiv.innerHTML = '';
              
              console.log('Selezionato performance ID:', perfId);
            });
          });
        })
        .catch(err => {
          console.error('Errore ricerca:', err);
          resultsDiv.innerHTML = '<div class="search-no-results">Errore durante la ricerca</div>';
          resultsDiv.classList.add('show');
        });
    }, 300);
  });

  // Chiudi risultati al click fuori
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
      resultsDiv.classList.remove('show');
    }
  });

  // Formatta data
  function formatDate(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    return date.toLocaleDateString('it-IT', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Escape HTML per sicurezza
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
})();
</script>
{% endblock %}
